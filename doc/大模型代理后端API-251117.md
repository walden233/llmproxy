# LLM Proxy 后端 API 文档

## 1. 概览
LLM Proxy 是一个基于 Spring Boot 3.x 的多模型代理服务，用于将 LangChain4j、阿里 DashScope、火山 Ark 等模型能力整合为统一 API。后台负责：
- 用户认证（JWT）与 Access Key 发放，支持余额校验、费用统计、订单管理。
- 模型与供应商（Provider）管理，按能力/优先级选择最佳模型，并支持多模态输入、函数调用、SSE 流式输出。
- 多种类型的第三方大模型代理，提供统一的同步和异步聊天、图像生成接口。
- 以 RabbitMQ 驱动异步任务；请求统计写入 MySQL + MongoDB。
- 对外提供聊天、图像生成、异步任务和统计查询接口。

代码目录：`src/main/java/cn/tyt/llmproxy`，部署说明见 `README.md` 与 `doc/docker-deployment.md`。本文档覆盖所有业务接口（忽略 `test_scripts/` 及示例代码）。

## 2. 服务入口与版本
- **根路径**：默认监听 `http://<host>:8060`。
- **REST 版本**：本文档以 `/v1` 命名空间为准；`/v1/v2` 前缀用于 OpenAI 兼容接口。
- **协议**：HTTP/HTTPS。流式接口通过 SSE (`text/event-stream`) 推送。

## 3. 安全与鉴权
### 3.1 JWT（管理端）
- `POST /v1/auth/login` 登录后返回 `token`。
- 管理端（模型、供应商、订单、统计、Access Key、异步任务查询等）必须在请求头携带 `Authorization: Bearer <token>`。
- Token 被 `JwtAuthenticationTokenFilter` 校验，并通过 `UserServiceImpl` 加载当前用户。

### 3.2 Access Key（能力调用端）
- 通过 `/v1/access-keys` 为账号生成 Key。
- 所有推理/生成 API **必须**在请求头携带 `ACCESS-KEY: <keyValue>`。
- `AccessKeyInterceptor` 会校验 Key 是否有效、余额是否充足，并将 `userId`、`accessKeyId` 注入请求上下文。

### 3.3 角色与权限
| 角色 | 说明 | 主要权限                               |
| ---- | ---- |------------------------------------|
| `ROLE_ROOT_ADMIN` | 超级管理员 | 用户角色分配、全部管理端接口                     |
| `ROLE_MODEL_ADMIN` | 模型运维 | `/v1/models/**`、`/v1/statistics/**` |
| `ROLE_USER` | 默认用户 | 自身订单、日志、账户、Access Key 管理           |

部分接口额外声明：
- `/v1/auth/assign-role`：`@PreAuthorize("hasAuthority('ROLE_ROOT_ADMIN')")`。
- `/v1/statistics/**`（除 `/mylog`）以及 `/v1/models/**`：需 `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN`。
- 其余 `/v1/**` 在 JWT 认证通过后即可访问，除非在 `SecurityConfig` 中显式 `permitAll`。

## 4. 通用约定
### 4.1 响应包装
除 OpenAI 兼容接口与 SSE 以外，所有接口返回 `Result<T>`：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}
```
`code` 对应 `ResultCode`（`cn.tyt.llmproxy.common.enums.ResultCode`）。常见错误：
- `401` 或 `401xxx`：未认证或 Token/Key 无效。
- `403xxx`：权限不足。
- `400xxx`：参数校验失败。
- `600xxx`：模型状态或配置错误。
- `700xxx`：上游模型调用异常。

### 4.2 分页结构
分页接口返回 MyBatis-Plus `IPage<T>`：
```json
{
  "records": [ ... ],
  "total": 23,
  "size": 10,
  "current": 1,
  "pages": 3
}
```

### 4.3 时间与编号
- 时间统一使用 ISO-8601，本地时区（通常为 `Asia/Shanghai`）。
- 所有主键为自增整型或 UUID（如 `AsyncJob.jobId`）。

## 5. 核心数据模型
### 5.1 用户与 Access Key
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `User.id` | Integer | 账号 ID |
| `username` | String | 唯一用户名 |
| `role` | String | `ROLE_ROOT_ADMIN` / `ROLE_MODEL_ADMIN` / `ROLE_USER` |
| `balance` | BigDecimal | 余额，Access Key 调用需余额充足 |
| `AccessKey.id` | Integer | Key 主键 |
| `keyValue` | String | 生成的密钥值，只返回一次 |
| `isActive` | Boolean | 是否启用 |
| `createdAt` | LocalDateTime | 创建时间 |

### 5.2 供应商与模型
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `Provider.id` | Integer | 供应商编号 |
| `name` | String | 供应商名称（唯一） |
| `urlBase` | String | API 基地址 |
| `ProviderKey.apiKey` | String | 厂商 Key，`status`=1 表示可用 |
| `LlmModel.id` | Integer | 模型编号 |
| `displayName` | String | 控制台展示名 |
| `modelIdentifier` | String | 真实调用 ID，同时用于 `/v1/v2/chat` 的 `model` 字段 |
| `capabilities` | List<String> | 模型能力，枚举见 `ModelCapabilityEnum`（`text-to-text`、`text-to-image` 等） |
| `pricing` | Map | Token/张数单价，可自定义结构 |
| `priority` | Integer | 数字越小优先 |
| `status` | Integer | `1`=在线，`0`=下线 |

### 5.3 订单与异步任务
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `Order.orderNo` | String | 业务订单号，RabbitMQ 延迟取消 |
| `status` | String | `PENDING` / `COMPLETED` / `FAILED` |
| `AsyncJob.jobId` | String | UUID，用于轮询结果 |
| `requestPayload` | Map | 原始请求体快照 |
| `resultPayload` | Map | 推理结果（chat/image） |
| `status` | String | `PENDING` / `PROCESSING` / `COMPLETED` / `FAILED` |
| `errorMessage` | String | 失败原因 |

### 5.4 统计与日志
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `ModelDailyStat.*` | MySQL | `modelId`、`modelIdentifier`、`statDate`、`totalRequests`、`successCount`、`failureCount` |
| `UsageLogDocument` | MongoDB | `userId`、`accessKeyId`、`modelId`、`promptTokens`、`completionTokens`、`imageCount`、`cost`、`isAsync`、`isSuccess`、`createTime` |

## 6. API 详情
本节基于 `doc/大模型代理后端API-251117.md` 与最新源码逐一细化 controller 层 API，包括参数类型/是否必填、权限控制与核心逻辑。

### 6.1 认证（AuthController `/v1/auth`）
| 方法 | 路径 | 权限/鉴权 | 说明 |
| ---- | ---- | ---------- | ---- |
| POST | `/v1/auth/register` | 公开 | 注册一个新账号 |
| POST | `/v1/auth/login` | 公开 | 颁发 JWT，用于后续需要认证的接口 |
| GET | `/v1/auth/me` | JWT | 查询当前登录用户资料 |
| POST | `/v1/auth/change-password` | JWT | 修改当前账号密码 |
| POST | `/v1/auth/assign-role` | `ROLE_ROOT_ADMIN` | 为指定用户分配角色 |

#### POST /v1/auth/register
| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `username` | String | 是（3~50 字符） | 新用户名，`UserServiceImpl.register` 会校验唯一性 |
| `password` | String | 是（6~100 字符） | 将被 BCrypt 加密存入 `passwordHash` |
| `email` | String | 否 | 有值时必须符合邮箱格式，且唯一 |

- 逻辑：`UserServiceImpl` 判重用户名/邮箱 → 默认角色 `ROLE_USER`、初始余额 `1.00`、状态 ACTIVE → 写入 MySQL（`users` 表），返回 `Result<String>`。

#### POST /v1/auth/login
| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `username` | String | 是 | 登录名 |
| `password` | String | 是 | 登录密码 |

- 逻辑：交给 `AuthenticationManager` 验证 → `JwtTokenUtil` 输出 token → 响应 `Result<UserLoginResponse>`（含 token、username、role）。密码错误抛 `ResultCode.AUTH_ERROR`。

#### GET /v1/auth/me
- 无额外参数，`JwtAuthenticationTokenFilter` 解析 token，返回 `Result<UserProfileResponse>`（`id`、`username`、`email`、`role`、`balance` 等）。

#### POST /v1/auth/change-password
| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `oldPassword` | String | 是 | 旧密码，需与当前用户匹配 |
| `newPassword` | String | 是（6~100 字符） | 新密码 |

- 逻辑：`UserServiceImpl.changePassword` 读取当前用户 → 校验旧密码 → 使用 BCrypt 重置密码 → 更新 `updatedAt`。

#### POST /v1/auth/assign-role
| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `userId` | Integer | 是 | 需要变更角色的用户 ID |
| `role` | String | 是 | 目标角色，必须为 `Roles` 中枚举 |

- 逻辑：`@PreAuthorize('hasAuthority('ROLE_ROOT_ADMIN')')` → 校验角色合法、不可修改 `ROLE_ROOT_ADMIN` 用户 → 更新 `user.role`，并通过 `@CachePut` 保持缓存一致。

### 6.2 Access Key（AccessKeyController `/v1/access-keys`）
| 方法 | 路径 | 权限/鉴权 | 说明 |
| ---- | ---- | ---------- | ---- |
| POST | `/v1/access-keys` | JWT | 为当前登录用户生成 Access Key |
| GET | `/v1/access-keys` | JWT | 列出当前用户的全部 Key |
| DELETE | `/v1/access-keys/{id}` | JWT | 删除当前用户的指定 Key |

- `ACCESS-KEY` 由 `AccessKeyServiceImpl.createAccessKey` 生成（`ak-` + UUID），只在创建响应中返回明文。
- 删除时校验所属关系，防止越权；Key 记录 `id/keyValue/isActive/createdAt`。

### 6.3 供应商与 Provider Key（ProviderController `/v1/providers`）
| 方法 | 路径 | 权限/鉴权 | 说明 |
| ---- | ---- | ---------- | ---- |
| POST | `/v1/providers` | JWT | 创建供应商 |
| GET | `/v1/providers/{id}` | JWT | 查询供应商详情 |
| GET | `/v1/providers` | JWT | 分页列表 |
| PUT | `/v1/providers/{id}` | JWT | 更新供应商 |
| DELETE | `/v1/providers/{id}` | JWT | 删除供应商及其 Key（若未被模型引用） |
| POST | `/v1/providers/keys` | JWT | 新增 Provider Key |
| GET | `/v1/providers/{providerId}/keys` | JWT | 列出 key |
| POST | `/v1/providers/keys/{keyId}/status` | JWT | 更新 key 状态 |
| DELETE | `/v1/providers/keys/{keyId}` | JWT | 删除 key |

**创建/更新 Provider 请求字段**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `name` | String | 创建必填，更新可选 | 供应商名称，唯一 |
| `urlBase` | String | 否 | 调用基地址 |

- 逻辑：`ProviderServiceImpl` 判重名称 → 写入 `providers` 表。删除前会确认没有模型引用该 provider，否则抛 `ResultCode.ILLEGAL_STATE`。

**分页查询参数**

| 参数 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- |
| `pageNum` | Integer | 否，默认 1 | 页码 |
| `pageSize` | Integer | 否，默认 10 | 页大小 |

**新增 Provider Key 请求字段**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `providerId` | Integer | `providerId` 与 `providerName` 二选一 | 指定供应商 |
| `providerName` | String | 同上 | 通过名称定位供应商 |
| `apiKey` | String | 是 | 厂商 Key，保存为密文 |

**更新 Key 状态请求字段**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `status` | Boolean | 否，默认 true | true=激活/false=禁用，对应 `ProviderKey.status` 1/0 |

- 逻辑：新增时校验供应商存在 → 默认 `STATUS_ACTIVE`；更新状态/删除都会校验 Key 是否存在。

### 6.4 模型管理（ModelController `/v1/models`）
| 方法 | 路径 | 权限 | 说明 |
| ---- | ---- | ---- | ---- |
| POST | `/v1/models` | `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN` | 创建模型配置 |
| GET | `/v1/models/{id}` | 同上 | 获取模型 |
| GET | `/v1/models` | 同上 | 分页列表，支持多条件 |
| PUT | `/v1/models/{id}` | 同上 | 更新模型 |
| POST | `/v1/models/{id}/status` | 同上 | 上/下线模型 |
| DELETE | `/v1/models/{id}` | 同上 | 删除模型 |
| POST | `/v1/models/usage` | 同上 | 查询模型日统计（MySQL `model_daily_stats`） |

**创建模型请求字段 (`ModelCreateRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `displayName` | String | 是 | 控制台展示名 |
| `modelIdentifier` | String | 是 | 真实调用 ID，必须唯一 |
| `capabilities` | List\<String> | 是 | 模型能力（如 `text-to-text`、`text-to-image`） |
| `pricing` | Map\<String,Object> | 否 | 自定义计费配置 |
| `providerName` | String | 否 | 可与 `providerId` 二选一 |
| `providerId` | Integer | 否 | 所属供应商 |
| `urlBase` | String | 否 | 自定义调用地址 |
| `apiKey` | String | 否 | 若随模型创建 Provider Key |
| `priority` | Integer | 是，>=1 | 模型选择优先级，数字越小越优先 |

**更新模型请求字段 (`ModelUpdateRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `displayName` | String | 否 | 新展示名 |
| `modelIdentifier` | String | 否 | 修改需保证唯一 |
| `capabilities` | List\<String> | 否 | 覆盖旧能力 |
| `pricing` | Map | 否 | 覆盖定价 |
| `providerId` | Integer | 否 | 切换供应商 |
| `priority` | Integer | 否，>=1 | 调整优先级 |

**更新状态请求字段 (`ModelStatusUpdateRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `status` | Integer | 是 | 1=上线、0=下线，`LangchainProxyServiceImpl` 会跳过下线模型 |

**列表查询参数**

| 参数 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- |
| `pageNum` | Integer | 否，默认 1 | 页码 |
| `pageSize` | Integer | 否，默认 10 | 页大小 |
| `status` | String | 否 | 过滤在线/下线 |
| `capability` | String | 否 | 根据能力过滤 |
| `sortBy` | String | 否，默认 `priority` | 支持 `priority/name/createdAt` |
| `sortOrder` | String | 否，默认 `asc` | `asc/desc` |

**统计查询体 (`StatisticsQueryDto`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `modelId` | Integer | 否 | 按模型主键过滤 |
| `modelIdentifier` | String | 否 | 与 `modelId` 二选一 |
| `date` | LocalDate | 否 | 指定日期；为空时默认当天 |

- 业务流程：`ILlmModelService` 负责 CRUD 并维护 Provider 关系；`statisticsService.getModelUsage` 会以 MySQL `upsert` 的 `model_daily_stats` 为数据源返回 `ModelStatisticsDto` 列表。

### 6.5 订单与余额（OrderController `/v1/orders`）
| 方法 | 路径 | 权限 | 说明 |
| ---- | ---- | ---- | ---- |
| POST | `/v1/orders` | JWT | 创建充值订单，同时发送 RabbitMQ 延迟取消消息 |
| GET | `/v1/orders/get` | JWT | 通过 `orderNo` 查询当前用户订单 |
| GET | `/v1/orders` | `ROLE_ROOT_ADMIN` | 运维分页查询所有订单 |
| GET | `/v1/orders/my` | JWT | 当前用户分页查询自己的订单 |
| POST | `/v1/orders/pay-success` | JWT | 用户支付成功回调入口 |
| POST | `/v1/orders/cancel` | JWT | 用户主动取消订单 |

**创建订单请求字段 (`OrderCreateRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `userId` | Integer | 是 | 下单用户 ID（通常由运营后台发起） |
| `amount` | BigDecimal | 是，>=0.01 | 充值金额 |

**查询与分页参数**

| 接口 | 参数 | 类型 | 必填 | 说明 |
| ---- | ---- | ---- | ---- | ---- |
| `/v1/orders/get` | `orderNo` | String | 是 | 需与当前用户匹配 |
| `/v1/orders` | `pageNum` | Integer | 否（默认 1） | |
|  | `pageSize` | Integer | 否（默认 10） | |
|  | `userId` | Integer | 否 | 过滤某个用户 |
|  | `status` | String | 否 | `PENDING/COMPLETED/FAILED` |
| `/v1/orders/my` | `pageNum` | Integer | 否 | |
|  | `pageSize` | Integer | 否 | |
|  | `status` | String | 否 | |

**订单号请求体 (`OrderNoResponse`)** —— `pay-success` 与 `cancel` 共用

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `orderNo` | String | 是 | 订单号 |

- 核心逻辑：`OrderServiceImpl.generateOrder` 生成 `UUID` 单号 → 发送延迟消息到 `RabbitMQConfig.ORDER_DELAY_ROUTING_KEY`，超时自动取消；`paySuccess` 做幂等检查与余额入账（调用 `UserServiceImpl.creditUserBalance`），并借助乐观锁防止并发；所有读写都会校验订单归属（除 `ROLE_ROOT_ADMIN` 以外不得跨账户）。

### 6.6 推理与多模态代理（ProxyController `/v1`）
| 方法 | 路径 | 权限/鉴权 | 说明 |
| ---- | ---- | ---------- | ---- |
| POST | `/v1/chat` | `permitAll` + `ACCESS-KEY` | 自定义聊天接口，返回 `Result<ChatResponse_dto>` |
| POST | `/v1/v2/chat` | `permitAll` + `ACCESS-KEY` | OpenAI `chat.completions` 兼容接口 |
| POST | `/v1/v2/chat/stream` | `permitAll` + `ACCESS-KEY` | SSE 流式聊天 |
| POST | `/v1/generate-image` | `permitAll` + `ACCESS-KEY` | 文生图接口 |
| POST | `/v1/async/chat` | `permitAll` + `ACCESS-KEY` | 异步聊天，立即返回 `jobId` |
| POST | `/v1/async/generate-image` | `permitAll` + `ACCESS-KEY` | 异步图像任务 |
| GET | `/v1/async/jobs/{jobId}` | JWT | 查询异步任务状态，仅限任务所属用户 |

**通用要求**
- 在调用推理/异步接口时，HTTP Header 必须包含 `ACCESS-KEY: <key>`。`AccessKeyInterceptor` 会校验 Key 有效性与余额，并把 `userId`、`accessKeyId` 注入到 `RequestAttribute` 中以便 Service 扣费/统计。
- `LangchainProxyServiceImpl` 会根据请求中 `modelInternalId`/`modelIdentifier`/`capabilities` 选择合适模型，调用 LangChain4j / 第三方 SDK；成功后写入 `UsageLogDocument`、`ModelDailyStat`，失败场景写入 Mongo 失败日志。

**`POST /v1/chat` 请求体 (`ChatRequest_dto`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `userMessage` | String | 否 | 当前用户文本。若为空，可通过 `history` 提供完整对话 |
| `modelInternalId` | Integer | 否 | 指定具体模型（MySQL `llm_models.id`） |
| `modelIdentifier` | String | 否 | 指定模型标识；两字段都省略时按能力/优先级自动选择 |
| `history` | List\<Map\> | 否 | 多轮上下文，元素需包含 `role`/`content` |
| `options` | Map | 否 | 模型特定参数（temperature、max_tokens 等） |
| `images` | List\<ImageInput> | 否 | 多模态输入，每项可包含 `base64` 或 `url` |

- 逻辑：`langchainProxyService.chat(request, userId, accessKeyId, false)` → 自动扣费/统计 → 返回 `ChatResponse_dto`（回答文本、实际模型、token 使用量）。

**OpenAI 兼容请求体 (`OpenAiChatRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `model` | String | 是 | 映射到 `LlmModel.modelIdentifier` |
| `messages` | List\<OpenAiMessage> | 是 | OpenAI 格式的消息数组，可混合文字/图像 |
| `temperature` | Double | 否 | 采样温度 |
| `top_p` | Double | 否 | nucleus sampling |
| `max_tokens` | Integer | 否 | 最大补全 token |
| `frequency_penalty` | Double | 否 | 重复惩罚 |
| `presence_penalty` | Double | 否 | 主题惩罚 |
| `stop` | List\<String> | 否 | 停止词 |
| `stream` | Boolean | 否 | 设置后会交给 `/chat/stream` 走 SSE |
| `parallel_tool_calls` | Boolean | 否 | 是否允许并发工具调用 |
| `tools` | List\<OpenAiTool> | 否 | 函数调用定义 |
| `tool_choice` | JsonNode | 否 | 指定工具执行策略 |
| `response_format` | OpenAiResponseFormat | 否 | JSON/Text 输出约束 |
| `metadata` | Map | 否 | 自定义上下文 |
| `extra_params` | Map | 否 | 厂商扩展参数，如 DashScope 特性 |

- 逻辑：参数转为 LangChain4j `OpenAiChatModel` 请求 → 返回与 OpenAI 官方一致的 `OpenAiChatResponse`。流式接口通过 `SseEmitter` 推送 chunk，并在异常时返回 `Result` JSON。

**`POST /v1/generate-image` 请求体 (`ImageGenerationRequest`)**

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `prompt` | String | 是 | 文生图提示词 |
| `modelInternalId` | Integer | 否 | 指定模型 |
| `modelIdentifier` | String | 否 | 指定模型标识 |
| `originImage` | ImageInput | 否 | 编辑/修复模式下的原始图（`base64` 或 `url`） |
| `options` | Map | 否 | 厂商参数，如 `size/n/seed/prompt_extend` |

- 逻辑：`LangchainProxyServiceImpl.generateImage` 通过 `ImageGeneratorFactory` 选择 DashScope / 火山 Ark 等实现 → 返回 `ImageGenerationResponse`（`imageUrls`、`actualPrompt`、`usedModelIdentifier`）。

**异步接口**
- `POST /v1/async/chat` 与 `POST /v1/async/generate-image` 共用同步请求体；服务端把请求转换为 Map → `asyncJobService.createAsyncJob` 持久化（`async_jobs` 表 + JacksonTypeHandler） → `asyncTaskProducerService` 投递到 RabbitMQ，对应消费者负责实际推理。
- 响应数据：

| 字段 | 类型 | 说明 |
| ----- | ---- | ---- |
| `jobId` | String | 异步任务 ID（UUID） |
| `status` | String | 初始为 `PENDING` |
| `message` | String | 文案提示 |

- `GET /v1/async/jobs/{jobId}`：路径参数 `jobId`（String，必填），`userService.getCurrentUser()` 校验归属后返回 `Result<AsyncJob>`，其中 `requestPayload`/`resultPayload` 为 Map（Jackson 序列化），`status` 可能为 `PENDING/PROCESSING/COMPLETED/FAILED`。

### 6.7 统计与日志（StatisticsController `/v1/statistics`）
| 方法 | 路径 | 权限/鉴权 | 说明 |
| ---- | ---- | ---------- | ---- |
| POST | `/v1/statistics` | `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN` | 查询模型日统计（与 `/v1/models/usage` 同 DTO） |
| GET | `/v1/statistics/user/{userId}` | 同上 | Mongo 中某用户的全部 `UsageLogDocument` |
| GET | `/v1/statistics/mylog` | JWT | `@PreAuthorize("isAuthenticated()")`，普通用户查看自身日志 |
| GET | `/v1/statistics/model/{modelId}` | `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN` | 查看指定模型日志 |
| POST | `/v1/statistics/logs/query` | `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN` | 组合条件查询日志 |

**`StatisticsQueryDto` 字段** —— 适用于 `/v1/statistics` 及 `/v1/models/usage`

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `modelId` | Integer | 否 | 目标模型主键 |
| `modelIdentifier` | String | 否 | 目标模型标识 |
| `date` | LocalDate | 否 | 查询日期，默认当天 |

**`UsageLogQueryDto` 字段** —— `/v1/statistics/logs/query`

| 字段 | 类型 | 必填 | 说明 |
| ----- | ---- | ---- | ---- |
| `userId` | Integer | 否 | 指定用户 |
| `accessKeyId` | Integer | 否 | 指定 Access Key |
| `modelId` | Integer | 否 | 指定模型 |
| `isSuccess` | Boolean | 否 | 成功/失败筛选 |
| `isAsync` | Boolean | 否 | 同步/异步筛选 |
| `startTime` | LocalDateTime (`yyyy-MM-dd HH:mm:ss`) | 否 | 起始时间 |
| `endTime` | LocalDateTime | 否 | 结束时间 |
| `limit` | Integer | 否 | 返回条数上限 |
| `sortDesc` | Boolean | 否，默认升序 | true 表示按 `createTime` 倒序 |

- 数据来源：`StatisticsServiceImpl` 通过 MongoRepository + `MongoTemplate` 查询 `usage_logs` 集合，按条件拼接 `Criteria` 并支持 limit/order；模型统计则读取 `model_daily_stats` 并转换为 `ModelStatisticsDto`。

---

## 7. 开发与排障提示
1. **模型选择**：`LangchainProxyServiceImpl` 会根据 `capabilities` 与 `priority` 自动挑选，并在失败时降级到下一 Key；若模型下线 (`status=0`)，会直接抛出 `MODEL_OFFLINE`。
2. **费用统计**：成功请求写入 `UsageLogDocument`（Mongo），每日聚合写入 `ModelDailyStat`。失败请求调用 `recordFailMongo`，方便排查。
3. **RabbitMQ**：异步任务使用 `async.chat.queue` / `async.image.queue`；订单取消使用 `order.delay.queue` + `order.cancel.queue`。
4. **测试脚本**：`test_scripts/` 提供 cURL 与 Python 示例，可在 Docker Compose 环境中验证 Access Key 调用链。
