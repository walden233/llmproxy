# LLM Proxy 后端 API 文档

## 1. 概览
LLM Proxy 是一个基于 Spring Boot 3.x 的多模型代理服务，用于将 LangChain4j、阿里 DashScope、火山 Ark 等模型能力整合为统一 API。后台负责：
- 用户认证（JWT）与 Access Key 发放，支持余额校验、费用统计、订单管理。
- 模型与供应商（Provider）管理，按能力/优先级选择最佳模型，并支持多模态输入、函数调用、SSE 流式输出。
- 以 RabbitMQ 驱动异步任务；请求统计写入 MySQL + MongoDB。
- 对外提供聊天、图像生成、异步任务和统计查询接口。

代码目录：`src/main/java/cn/tyt/llmproxy`，部署说明见 `README.md` 与 `doc/docker-deployment.md`。本文档覆盖所有业务接口（忽略 `test_scripts/` 及示例代码）。

## 2. 服务入口与版本
- **根路径**：默认监听 `http://<host>:8060`。
- **REST 版本**：本文档以 `/v1` 命名空间为准；`/v1/v2` 前缀用于 OpenAI 兼容接口。
- **协议**：HTTP/HTTPS。流式接口通过 SSE (`text/event-stream`) 推送。

## 3. 安全与鉴权
### 3.1 JWT（管理端）
- `POST /v1/auth/login` 登录后返回 `token`。
- 管理端（模型、供应商、订单、统计、Access Key、异步任务查询等）必须在请求头携带 `Authorization: Bearer <token>`。
- Token 被 `JwtAuthenticationTokenFilter` 校验，并通过 `UserServiceImpl` 加载当前用户。

### 3.2 Access Key（能力调用端）
- 通过 `/v1/access-keys` 为账号生成 Key。
- 所有推理/生成 API **必须**在请求头携带 `ACCESS-KEY: <keyValue>`。
- `AccessKeyInterceptor` 会校验 Key 是否有效、余额是否充足，并将 `userId`、`accessKeyId` 注入请求上下文。

### 3.3 角色与权限
| 角色 | 说明 | 主要权限 |
| ---- | ---- | -------- |
| `ROLE_ROOT_ADMIN` | 超级管理员 | 用户角色分配、全部管理端接口 |
| `ROLE_MODEL_ADMIN` | 模型运维 | `/v1/models/**`、`/v1/statistics/**` |
| `ROLE_USER` | 默认用户 | Access Key 管理、订单、自身日志 |

部分接口额外声明：
- `/v1/auth/assign-role`：`@PreAuthorize("hasAuthority('ROLE_ROOT_ADMIN')")`。
- `/v1/statistics/**`（除 `/mylog`）以及 `/v1/models/**`：需 `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN`。
- 其余 `/v1/**` 在 JWT 认证通过后即可访问，除非在 `SecurityConfig` 中显式 `permitAll`。

## 4. 通用约定
### 4.1 响应包装
除 OpenAI 兼容接口与 SSE 以外，所有接口返回 `Result<T>`：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... }
}
```
`code` 对应 `ResultCode`（`cn.tyt.llmproxy.common.enums.ResultCode`）。常见错误：
- `401` 或 `401xxx`：未认证或 Token/Key 无效。
- `403xxx`：权限不足。
- `400xxx`：参数校验失败。
- `600xxx`：模型状态或配置错误。
- `700xxx`：上游模型调用异常。

### 4.2 分页结构
分页接口返回 MyBatis-Plus `IPage<T>`：
```json
{
  "records": [ ... ],
  "total": 23,
  "size": 10,
  "current": 1,
  "pages": 3
}
```

### 4.3 时间与编号
- 时间统一使用 ISO-8601，本地时区（通常为 `Asia/Shanghai`）。
- 所有主键为自增整型或 UUID（如 `AsyncJob.jobId`）。

## 5. 核心数据模型
### 5.1 用户与 Access Key
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `User.id` | Integer | 账号 ID |
| `username` | String | 唯一用户名 |
| `role` | String | `ROLE_ROOT_ADMIN` / `ROLE_MODEL_ADMIN` / `ROLE_USER` |
| `balance` | BigDecimal | 余额，Access Key 调用需余额充足 |
| `AccessKey.id` | Integer | Key 主键 |
| `keyValue` | String | 生成的密钥值，只返回一次 |
| `isActive` | Boolean | 是否启用 |
| `createdAt` | LocalDateTime | 创建时间 |

### 5.2 供应商与模型
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `Provider.id` | Integer | 供应商编号 |
| `name` | String | 供应商名称（唯一） |
| `urlBase` | String | API 基地址 |
| `ProviderKey.apiKey` | String | 厂商 Key，`status`=1 表示可用 |
| `LlmModel.id` | Integer | 模型编号 |
| `displayName` | String | 控制台展示名 |
| `modelIdentifier` | String | 真实调用 ID，同时用于 `/v1/v2/chat` 的 `model` 字段 |
| `capabilities` | List<String> | 模型能力，枚举见 `ModelCapabilityEnum`（`text-to-text`、`text-to-image` 等） |
| `pricing` | Map | Token/张数单价，可自定义结构 |
| `priority` | Integer | 数字越小优先 |
| `status` | Integer | `1`=在线，`0`=下线 |

### 5.3 订单与异步任务
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `Order.orderNo` | String | 业务订单号，RabbitMQ 延迟取消 |
| `status` | String | `PENDING` / `COMPLETED` / `FAILED` |
| `AsyncJob.jobId` | String | UUID，用于轮询结果 |
| `requestPayload` | Map | 原始请求体快照 |
| `resultPayload` | Map | 推理结果（chat/image） |
| `status` | String | `PENDING` / `PROCESSING` / `COMPLETED` / `FAILED` |
| `errorMessage` | String | 失败原因 |

### 5.4 统计与日志
| 字段 | 类型 | 说明 |
| ---- | ---- | ---- |
| `ModelDailyStat.*` | MySQL | `modelId`、`modelIdentifier`、`statDate`、`totalRequests`、`successCount`、`failureCount` |
| `UsageLogDocument` | MongoDB | `userId`、`accessKeyId`、`modelId`、`promptTokens`、`completionTokens`、`imageCount`、`cost`、`isAsync`、`isSuccess`、`createTime` |

## 6. API 详情
### 6.1 认证（AuthController `/v1/auth`）
| 方法 | 路径 | 权限 | 说明 |
| ---- | ---- | ---- | ---- |
| POST | `/register` | 公开 | 注册账号（仅用户名/密码/邮箱） |
| POST | `/login` | 公开 | 登录并返回 JWT |
| POST | `/change-password` | 登录 | 修改当前账号密码 |
| POST | `/assign-role` | `ROLE_ROOT_ADMIN` | 更新指定用户角色 |

**注册**
```http
POST /v1/auth/register
Content-Type: application/json

{
  "username": "demo",
  "password": "P@ssw0rd",
  "email": "demo@example.com"
}
```
响应：`Result<String>`（返回用户名）。

**登录**
```http
POST /v1/auth/login
Authorization: (无)

{
  "username": "demo",
  "password": "P@ssw0rd"
}
```
响应：
```json
{
  "code": 200,
  "data": {
    "token": "<JWT>",
    "username": "demo",
    "role": "ROLE_USER"
  }
}
```

**修改密码**：请求体 `{ "oldPassword": "xxx", "newPassword": "yyy" }`。
**分配角色**：`{ "userId": 3, "role": "ROLE_MODEL_ADMIN" }`。

### 6.2 Access Key 管理（AccessKeyController `/v1/access-keys`）
所有接口需 JWT，并针对当前登录用户。
| 方法 | 路径 | 说明 |
| ---- | ---- | ---- |
| POST | `/v1/access-keys` | 生成新的 Key，返回 `AccessKey` 对象（`keyValue` 仅在创建时可见） |
| GET | `/v1/access-keys` | 列出当前用户的 Key 列表 |
| DELETE | `/v1/access-keys/{id}` | 删除指定 Key |

示例响应：
```json
{
  "code": 200,
  "data": {
    "id": 12,
    "keyValue": "sk-xxxx",
    "userId": 1,
    "isActive": true,
    "createdAt": "2025-07-28T10:12:30"
  }
}
```

### 6.3 供应商与 Key（ProviderController `/v1/providers`）
需 JWT；建议仅授予运维角色调用。
| 方法 | 路径 | 说明 |
| ---- | ---- | ---- |
| POST | `/v1/providers` | 创建供应商 `{ "name": "DashScope", "urlBase": "https://dashscope.aliyuncs.com" }` |
| GET | `/v1/providers/{id}` | 查询供应商详情 |
| GET | `/v1/providers` | 分页查询，参数 `pageNum`、`pageSize` |
| PUT | `/v1/providers/{id}` | 更新名称/URL |
| DELETE | `/v1/providers/{id}` | 删除供应商（若仍有关联模型会抛错） |
| POST | `/v1/providers/keys` | 为供应商添加 API Key。可通过 `providerId` 或 `providerName` 指定供应商。 |
| GET | `/v1/providers/{providerId}/keys` | 列出 Key |
| POST | `/v1/providers/keys/{keyId}/status` | 更新 Key 状态 `{ "status": true }` |
| DELETE | `/v1/providers/keys/{keyId}` | 删除 Key |

### 6.4 模型管理（ModelController `/v1/models`）
需 `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN`。

**创建模型**
```http
POST /v1/models
Authorization: Bearer <token>

{
  "displayName": "DashScope Qwen-Plus",
  "modelIdentifier": "qwen-plus",
  "capabilities": ["text-to-text"],
  "pricing": {"prompt": 3e-6, "completion": 4e-6},
  "priority": 1,
  "providerId": 2,
  "providerName": "DashScope",
  "urlBase": "https://dashscope.aliyuncs.com" ,
  "apiKey": "sk-provider"
}
```
返回 `ModelResponse`：
```json
{
  "id": 5,
  "displayName": "DashScope Qwen-Plus",
  "modelIdentifier": "qwen-plus",
  "capabilities": ["text-to-text"],
  "priority": 1,
  "status": 1,
  "providerId": "2",
  "providerName": "DashScope",
  "urlBase": "https://dashscope.aliyuncs.com"
}
```

**查询**
- `GET /v1/models/{id}`：返回 `ModelResponse`。
- `GET /v1/models`：支持 `pageNum`、`pageSize`、`status` (`0/1`)、`capability`（如 `text-to-image`）、`sortBy`（`priority`/`name`/`createdAt`）、`sortOrder` (`asc/desc`)。
- `PUT /v1/models/{id}`：更新显示名称、标识、能力、定价、供应商、优先级。
- `POST /v1/models/{id}/status`：`{ "status": 1 }` 上线 / `0` 下线。
- `DELETE /v1/models/{id}`：删除模型。

**模型日统计**
- `POST /v1/models/usage`：`StatisticsQueryDto`（`modelId` 或 `modelIdentifier`，可选 `date`）。空请求默认查询当日所有模型：
```http
POST /v1/models/usage
{
  "modelId": 5,
  "date": "2025-07-28"
}
```
响应（`ModelStatisticsDto` 列表）：
```json
[
  {
    "date": "2025-07-28",
    "modelId": 5,
    "modelIdentifier": "qwen-plus",
    "totalRequests": 42,
    "successCount": 40,
    "failureCount": 2
  }
]
```

### 6.5 订单与余额（OrderController `/v1/orders`）
需 JWT；通常由运营端使用。
| 方法 | 路径 | 说明 |
| ---- | ---- | ---- |
| POST | `/v1/orders` | 创建订单 `{ "userId": 1, "amount": 100.00 }`，状态初始为 `PENDING`，订单号会写入延迟队列待自动取消 |
| GET | `/v1/orders/get?orderNo=xxx` | 根据业务单号查询 |
| GET | `/v1/orders` | 分页查询，支持 `userId`、`status` 过滤 |
| POST | `/v1/orders/pay-success` | 支付回调 `{ "orderNo": "20240728001" }`，内部触发余额入账 |
| POST | `/v1/orders/cancel` | 手动取消订单 `{ "orderNo": "20240728001" }` |

响应均为 `OrderResponse` 或分页结果。

### 6.6 推理与多模态代理（ProxyController `/v1`）
这些接口通过 `SecurityConfig` 标记为 `permitAll`，但 `AccessKeyInterceptor` 会强制检查 `ACCESS-KEY` 请求头。`Result` 包装除 OpenAI 兼容接口外均适用。

**6.6.1 自定义聊天 `POST /v1/chat`**
请求体 `ChatRequest_dto`：
```json
{
  "userMessage": "介绍一下火山引擎",
  "modelInternalId": 5,
  "modelIdentifier": "qwen-plus",
  "history": [
    {"role": "user", "content": "你好"},
    {"role": "assistant", "content": "您好"}
  ],
  "options": {"temperature": 0.3},
  "images": [
    {"url": "https://example.com/cat.png"}
  ]
}
```
- `modelInternalId` 或 `modelIdentifier` 可选，均缺省时会根据能力/优先级自动选择。
- `images` 支持 `base64` 或 `url`，用于多模态输入。

响应 `ChatResponse_dto`：
```json
{
  "assistantMessage": "...",
  "usedModelIdentifier": "qwen-plus",
  "inputTokensCount": 320,
  "outputTokensCount": 128
}
```

**6.6.2 OpenAI 兼容 `POST /v1/v2/chat`**
完全复用 OpenAI `chat.completions` 协议，返回 `OpenAiChatResponse`。请求示例：
```json
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": [
        {"type": "text", "text": "写一首诗"},
        {"type": "image_url", "image_url": {"url": "https://.../cat.png"}}
      ]
    }
  ],
  "temperature": 0.8,
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "get_weather",
        "description": "查询天气",
        "parameters": {"type": "object", "properties": {"city": {"type": "string"}}, "required": ["city"]}
      }
    }
  ],
  "response_format": {"type": "json_object"},
  "extra_params": {"dashscope:enable_search": true}
}
```
- 支持 `tool_calls`、`tool_choice`、`parallel_tool_calls`、`response_format`、`stop`、`metadata` 等 OpenAI 字段。
- 返回结构与 OpenAI 官方一致（`choices[]`、`usage`、`system_fingerprint`）。

**6.6.3 流式聊天 `POST /v1/v2/chat/stream`**
- `Content-Type: application/json`，响应 `text/event-stream`。
- 首个 chunk 包含 `role: assistant`，随后每个 chunk 形如：
```json
{
  "id": "chatcmpl-...",
  "object": "chat.completion.chunk",
  "created": 1722155241,
  "model": "qwen-plus",
  "choices": [
    {
      "index": 0,
      "delta": {
        "content": [{"type": "text", "text": "部分文本"}]
      },
      "finish_reason": null
    }
  ]
}
```
- 终止 chunk 会在 `delta.tool_calls` 中返回函数调用，并设置 `finish_reason`；最后发送 `[DONE]`。
- 若出错，会推送 `Result` JSON，之后 `SseEmitter` 关闭。

**6.6.4 图像生成 `POST /v1/generate-image`**
```json
{
  "prompt": "火星上的橘猫",
  "modelIdentifier": "ark-imagine-v1",
  "originImage": {"base64": "..."},
  "options": {"size": "1024x1024", "n": 2, "seed": 42}
}
```
响应：
```json
{
  "code": 200,
  "data": {
    "imageUrls": ["https://oss/.../1.png", "https://oss/.../2.png"],
    "actualPrompt": "...",
    "usedModelIdentifier": "ark-imagine-v1"
  }
}
```

### 6.7 异步任务
- `POST /v1/async/chat`
- `POST /v1/async/generate-image`
  - 请求体与同步接口一致，仍需 `ACCESS-KEY`。
  - 服务端创建 `AsyncJob`，将任务投递至 RabbitMQ `async.task.exchange` 对应队列。
  - 响应格式：
```json
{
  "code": 200,
  "data": {
    "jobId": "c6df...",
    "status": "PENDING",
    "message": "Task submitted successfully"
  }
}
```

- `GET /v1/async/jobs/{jobId}`：需 JWT；仅任务所属用户可查。返回 `AsyncJob`：
```json
{
  "code": 200,
  "data": {
    "jobId": "c6df...",
    "userId": 1,
    "accessKeyId": 12,
    "modelName": "qwen-plus",
    "status": "COMPLETED",
    "requestPayload": { ... 原始请求 ... },
    "resultPayload": { ... ChatResponse 或 ImageGenerationResponse ... },
    "errorMessage": null,
    "createdAt": "2025-07-28T10:20:00",
    "updatedAt": "2025-07-28T10:20:05"
  }
}
```

### 6.8 统计与日志（StatisticsController `/v1/statistics`）
除了 `/mylog`，均需 `ROLE_MODEL_ADMIN` 或 `ROLE_ROOT_ADMIN`。
| 方法 | 路径 | 说明 |
| ---- | ---- | ---- |
| POST | `/v1/statistics` | 与 `/v1/models/usage` 相同，按模型 ID/标识 + 日期查询 `ModelStatisticsDto` |
| GET | `/v1/statistics/user/{userId}` | 返回 MongoDB 中指定用户的所有 `UsageLogDocument` |
| GET | `/v1/statistics/mylog` | 当前登录用户查看自己的用量日志 |
| GET | `/v1/statistics/model/{modelId}` | 查询某模型的用量日志 |
| POST | `/v1/statistics/logs/query` | 组合查询，自定义过滤 |

`UsageLogQueryDto` 字段：`userId`、`accessKeyId`、`modelId`、`isSuccess`、`isAsync`、`startTime`、`endTime`（`yyyy-MM-dd HH:mm:ss`）、`limit`、`sortDesc`。示例：
```http
POST /v1/statistics/logs/query
{
  "userId": 1,
  "isAsync": true,
  "startTime": "2025-07-01 00:00:00",
  "endTime": "2025-07-28 23:59:59",
  "limit": 100,
  "sortDesc": true
}
```
响应：
```json
[
  {
    "userId": 1,
    "modelId": 5,
    "promptTokens": 200,
    "completionTokens": 120,
    "imageCount": null,
    "cost": "-0.0056",
    "isAsync": false,
    "isSuccess": true,
    "createTime": "2025-07-28T10:22:00"
  }
]
```

---

## 7. 开发与排障提示
1. **模型选择**：`LangchainProxyServiceImpl` 会根据 `capabilities` 与 `priority` 自动挑选，并在失败时降级到下一 Key；若模型下线 (`status=0`)，会直接抛出 `MODEL_OFFLINE`。
2. **费用统计**：成功请求写入 `UsageLogDocument`（Mongo），每日聚合写入 `ModelDailyStat`。失败请求调用 `recordFailMongo`，方便排查。
3. **RabbitMQ**：异步任务使用 `async.chat.queue` / `async.image.queue`；订单取消使用 `order.delay.queue` + `order.cancel.queue`。
4. **测试脚本**：`test_scripts/` 提供 cURL 与 Python 示例，可在 Docker Compose 环境中验证 Access Key 调用链。
